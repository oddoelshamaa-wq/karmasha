<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุชุญูู ูุฑูุดุฉ - ูุชุงุจุนุฉ ุงูุทูุจุงุช</title>
    <link rel="stylesheet" href="admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <!-- ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู ููููุธููู -->
    <div id="admin-login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#d2000a; z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column; color:white;">
        <img src="5515928d-da81-433e-8bc9-245180ba6724.jpg" style="width:150px; border-radius:20px; margin-bottom:20px;">
        <h2>ุชุณุฌูู ุฏุฎูู ุงูููุธููู</h2>
        <div style="background:white; padding:30px; border-radius:15px; display:flex; flex-direction:column; gap:10px; width:300px;">
            <input type="text" id="admin-user" placeholder="ุงุณู ุงููุณุชุฎุฏู" style="padding:10px; border:1px solid #ddd; border-radius:5px;">
            <input type="password" id="admin-pass" placeholder="ูููุฉ ุงููุฑูุฑ" style="padding:10px; border:1px solid #ddd; border-radius:5px;">
            <button onclick="handleAdminLogin()" style="background:#d2000a; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold;">ุฏุฎูู</button>
        </div>
        <p id="login-error" style="color:yellow; margin-top:10px; display:none;">ุฎุทุฃ ูู ุงูุจูุงูุงุช!</p>
    </div>

    <!-- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ (Sidebar) -->
    <div class="sidebar">
        <div class="admin-logo-section">
            <img src="5515928d-da81-433e-8bc9-245180ba6724.jpg" alt="Admin Logo" class="admin-logo">
            <p>ููุญุฉ ุงูุชุญูู</p>
        </div>
        
        <nav class="side-nav">
            <ul>
                <li id="nav-orders" class="active"><a href="#"><i class="fas fa-bell"></i> ุงูุทูุจุงุช ุงูุญูุฉ</a></li>
                <li id="nav-records"><a href="#"><i class="fas fa-chart-line"></i> ุงูุณุฌู ูุงูุฅุญุตุงุฆูุงุช</a></li>
                <li id="nav-chat"><a href="#"><i class="fas fa-comments"></i> ุดุงุช ุงูุนููุงุก</a></li>
                <!-- ุงูุญุงุฌุงุช ุฏู ูููุฏูุฑ ููุท -->
                <li id="nav-products" class="manager-only"><a href="#"><i class="fas fa-box"></i> ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</a></li>
                <li id="nav-categories" class="manager-only"><a href="#"><i class="fas fa-list"></i> ุฅุฏุงุฑุฉ ุงูุฃูุณุงู</a></li>
                <li id="nav-add-product" class="manager-only"><a href="#"><i class="fas fa-plus-circle"></i> ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ</a></li>
                <li id="nav-staff" class="manager-only"><a href="#"><i class="fas fa-user-tie"></i> ุงูููุธููู</a></li>
            </ul>
        </nav>

        <button class="logout-btn"><i class="fas fa-sign-out-alt"></i> ุฎุฑูุฌ</button>
    </div>

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
    <div class="main-content">
        <header class="top-bar">
            <div class="server-status">
                <span class="dot"></span> ูุชุตู ุจุงูุฎุงุฏู
            </div>
            <div class="page-title" id="current-page-title">
                โก ุงูุทูุจุงุช ุงูุญูุฉ
            </div>
        </header>

        <!-- ูุณู ุงูุทูุจุงุช ุงูุญูุฉ (ุดุบุงู ุงูุชุฑุงุถูุงู) -->
        <section id="live-orders-section" class="admin-section active">
            <div class="orders-container">

                <!-- ุนููุฏ ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ -->
                <div class="order-column">
                    <div class="column-header red-header">
                        <span><i class="fas fa-star"></i> ุทูุจุงุช ุฌุฏูุฏุฉ ุฑุงุฌุนูุง</span>
                    </div>

                    <div class="order-list" id="new-orders">
                        <!-- ูุงุฑุช ุทูุจ -->
                        <div class="order-card">
                            <div class="card-header">
                                <span class="order-id">#eJ5H</span>
                                <span class="order-time">07:42 ู</span>
                            </div>
                            <div class="customer-info">
                                <h4>ุดูุดูู</h4>
                                <p><i class="fas fa-map-marker-alt"></i> ุงููุนุงุฏู - ูุด</p>
                            </div>
                            <div class="card-footer">
                                <button class="details-btn">ุงูุชูุงุตูู</button>
                                <span class="price">30 ุฌ</span>
                            </div>
                        </div>

                        <div class="order-card">
                            <div class="card-header">
                                <span class="order-id">#OvsK</span>
                                <span class="order-time">02:21 ู</span>
                            </div>
                            <div class="customer-info">
                                <h4>ูุญููุฏ</h4>
                                <p><i class="fas fa-map-marker-alt"></i> ูุตุฑ ุงูุฌุฏูุฏุฉ - ุนูุงุฑุฉ 17Bุ ุดุงุฑุน ูุญูุฏ ุจุฏุฑ</p>
                            </div>
                            <div class="card-footer">
                                <button class="details-btn">ุงูุชูุงุตูู</button>
                                <span class="price">37 ุฌ</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ุนููุฏ ูู ุงููุทุจุฎ -->
                <div class="order-column">
                    <div class="column-header blue-header">
                        <span><i class="fas fa-fire"></i> ูู ุงููุทุจุฎ (ุฌุงุฑู)</span>
                    </div>

                    <div class="order-list" id="kitchen-orders">
                        <div class="order-card kitchen-card">
                            <div class="card-header">
                                <span class="order-id">#LKCu</span>
                                <span class="order-time">10:03 ุต</span>
                            </div>
                            <div class="customer-info">
                                <h4>ูุญููุฏ</h4>
                                <p><i class="fas fa-map-marker-alt"></i> ูุตุฑ ุงูุฌุฏูุฏุฉ - ุนูุงุฑุฉ 17Bุ ุดุงุฑุน ูุญูุฏ ุจุฏุฑ</p>
                            </div>
                            <div class="card-footer">
                                <button class="details-btn">ุงูุชูุงุตูู</button>
                                <span class="price">37 ุฌ</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- ูุณู ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช -->
        <section id="manage-products-section" class="admin-section">
            <div class="table-container">
                <h3>ูุงุฆูุฉ ูุฌุจุงุช ูุทุนู ูุฑูุดุฉ</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ุงููุฌุจุฉ</th>
                            <th>ุงูุณุนุฑ (ุนุงุฏู)</th>
                            <th>ุงููุณู</th>
                            <th>ุงูุญุงูุฉ</th>
                            <th>ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                        <!-- ุงูููุชุฌุงุช ุณุชูุญูู ุฏููุงููููุงู -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ูุณู ุฅุฏุงุฑุฉ ุฃูุณุงู ุงููููู ูู ุตูุญุฉ ุงูุฃุฏูู -->
        <section id="manage-categories-section" class="admin-section">
            <div class="table-container">
                <h3>ุฅุฏุงุฑุฉ ุฃูุณุงู ุงููููู (ุงููุงุฆูุฉ ุงูุนูููุฉ)</h3>
                <div class="admin-card">
                    <h3>ุฅุถุงูุฉ ูุณู ุฌุฏูุฏ ูููุงุฆูุฉ</h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="categoryInput" placeholder="ุงูุชุจ ุงุณู ุงููุณู (ูุซูุงู: ุนุฑูุถ ุงูุดุชุงุก)">
                        <button onclick="saveCategory()" class="btn-add">ุฅุถุงูุฉ ุงููุณู</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ุงุณู ุงููุณู</th>
                            <th>ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="admin-categories-table">
                        <!-- ุงูุฃูุณุงู ูุชุธูุฑ ููุง ุจุฑูุฌูุงู -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ูุณู ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ -->
        <section id="add-product-section" class="admin-section">
            <div class="form-container">
                <h3>ุฅุถุงูุฉ ูุฌุจุฉ ุฌุฏูุฏุฉ ูููููู</h3>
                <form id="add-food-form">
                    <input type="text" id="food-name" placeholder="ุงุณู ุงููุฌุจุฉ" required>
                    <div class="prices-section">
                        <label>ุงูุฃุญุฌุงู ูุงูุฃุณุนุงุฑ:</label>
                        <div id="prices-container">
                            <!-- ุฃูู ุตู ููููู ููุฌูุฏ ุฏุงููุงู -->
                            <div class="price-row">
                                <input type="text" placeholder="ุงูุญุฌู (ูุซูุงู: ูุณุท)" class="size-input">
                                <input type="number" placeholder="ุงูุณุนุฑ" class="price-input">
                            </div>
                        </div>
                        <button type="button" onclick="addPriceRow()" class="btn-add-size">+ ุฅุถุงูุฉ ุญุฌู ุขุฎุฑ</button>
                    </div>
                    <input type="file" id="food-img-file" accept="image/*">
                    <textarea id="food-desc" placeholder="ูุตู ุงููุฌุจุฉ"></textarea>
                    <select id="categorySelect" required>
                        <option value="">ุงุฎุชุฑ ุงููุณู</option>
                    </select>
                    <button type="submit" class="btn-main-red">ุญูุธ ุงูููุชุฌ</button>
                </form>
            </div>
        </section>

        <!-- ูุณู ุณุฌู ุงูุทูุจุงุช -->
        <section id="records-section" class="admin-section">
            <div class="table-container" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>๐ ุณุฌู ุงููุจูุนุงุช ูุงูุทูุจุงุช</h3>
                    <div class="filter-box">
                        <input type="text" id="searchOrders" placeholder="ุจุญุซ ุจุงุณู ุงูุนููู ุฃู ุงูุฑูู..." onkeyup="filterRecords()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; text-align: right;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #eee;">
                            <th style="padding: 15px;">ุฑูู ุงูุทูุจ</th>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูุนููู</th>
                            <th>ุงููุฌุจุงุช</th>
                            <th>ุงูุฅุฌูุงูู</th>
                            <th>ุงูุญุงูุฉ</th>
                        </tr>
                    </thead>
                    <tbody id="records-table-body">
                        <!-- ุงูุจูุงูุงุช ูุชุธูุฑ ููุง ุจุงูู JS -->
                    </tbody>
                </table>

                <div style="margin-top: 20px; padding: 15px; background: #e31e24; color: white; border-radius: 10px; display: inline-block;">
                    ุฅุฌูุงูู ูุจูุนุงุช ุงูุณุฌู: <span id="total-sales-amount" style="font-weight: bold; font-size: 20px;">0</span> ุฌ.ู
                </div>
            </div>
        </section>

        <!-- ูุณู ุฅุฏุงุฑุฉ ุงูููุธููู -->
        <section id="manage-staff-section" class="admin-section">
            <div class="table-container">
                <h3>๐ฅ ุฅุฏุงุฑุฉ ุทุงูู ุงูุนูู ูุงูุตูุงุญูุงุช</h3>

                <!-- ููุฑู ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ -->
                <div class="admin-card" style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4>ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="staff-username" placeholder="ุงุณู ุงููุณุชุฎุฏู (ููุฅุฏูู)">
                        <input type="password" id="staff-password" placeholder="ูููุฉ ุงููุฑูุฑ">
                        <input type="text" id="staff-job-title" placeholder="ุงููุณูู ุงููุธููู (ูุซูุงู: ูุงุดูุฑ)">
                    </div>

                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <p style="font-weight: bold; margin-bottom: 10px;">ุญุฏุฏ ุงูุตูุงุญูุงุช ุงููุณููุญุฉ:</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                            <label><input type="checkbox" class="perm-check" value="orders"> ุงูุทูุจุงุช ุงูุญูุฉ</label>
                            <label><input type="checkbox" class="perm-check" value="records"> ุงูุณุฌู ูุงูุฅุญุตุงุฆูุงุช</label>
                            <label><input type="checkbox" class="perm-check" value="chat"> ุดุงุช ุงูุนููุงุก</label>
                            <label><input type="checkbox" class="perm-check" value="products"> ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</label>
                            <label><input type="checkbox" class="perm-check" value="categories"> ุฅุฏุงุฑุฉ ุงูุฃูุณุงู</label>
                        </div>
                    </div>
                    <button onclick="saveNewStaff()" class="btn-add" style="margin-top: 15px; width: 100%; padding: 12px;">ุญูุธ ุงูููุธู ุงูุฌุฏูุฏ</button>
                </div>

                <!-- ุฌุฏูู ุนุฑุถ ุงูููุธููู -->
                <table>
                    <thead>
                        <tr>
                            <th>ุงูููุธู</th>
                            <th>ุงููุธููุฉ</th>
                            <th>ุงูุตูุงุญูุงุช</th>
                            <th>ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="staff-table-body">
                        <!-- ุงูููุธููู ููุธูุฑูุง ููุง -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>


      <script>
        // ุจูุงูุงุช ุงูููุธููู (ูุคูุชุงู ูุญุฏ ูุง ุชุฑุจุทูุง ุจูุงูุฑุจูุฒ)
        const staffDatabase = [
            { user: "admin", pass: "123", role: "ูุฏูุฑ" },
            { user: "order1", pass: "456", role: "ูุชููู" }
        ];

        window.handleAdminLogin = async function() {
            const userInp = document.getElementById('admin-user').value.trim();
            const passInp = document.getElementById('admin-pass').value.trim();

            // 1. ุฏุฎูู "ุงูุณูุจุฑ ุฃุฏูู" (admin) - ุดุบุงู ุฏุงููุงู ุญุชู ูู ูููุด ูุช
            if (userInp === "admin" && passInp === "123") {
                document.getElementById('admin-login-overlay').style.display = 'none';

                // ุฅุนุทุงุก ุตูุงุญูุงุช ูุงููุฉ ูููุฏูุฑ
                const fullPerms = {
                    orders: true, records: true, chat: true,
                    products: true, categories: true
                };
                applyDynamicPermissions(fullPerms);

                // ุชุดุบูู ุฌูุจ ุงูุจูุงูุงุช ุจุนุฏ ุงูุฏุฎูู
                if (typeof loadStaffList === "function") loadStaffList();
                if (typeof loadProds === "function") loadProds();

                console.log("ุชู ุงูุฏุฎูู ุจุตูุงุญูุฉ ุงูุณูุจุฑ ุฃุฏูู");
                return;
            }

            // 2. ุงููุญุงููุฉ ูุน ุงูุณูุฑูุฑ ููููุธููู ุงูุขุฎุฑูู
            try {
                if (!window.db) {
                    throw new Error("ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ุชุชุญูู ุจุนุฏ");
                }

                // ูุณุชุฎุฏู window. ููุชุฃูุฏ ูู ุงููุตูู ููุฏูุงู
                const q = window.query(
                    window.collection(window.db, "staff"),
                    window.where("username", "==", userInp),
                    window.where("password", "==", passInp)
                );

                const querySnapshot = await window.getDocs(q);

                if (!querySnapshot.empty) {
                    const staffData = querySnapshot.docs[0].data();
                    document.getElementById('admin-login-overlay').style.display = 'none';
                    applyDynamicPermissions(staffData.permissions);
                } else {
                    alert("ุงุณู ุงููุณุชุฎุฏู ุฃู ุงูุจุงุณูุฑุฏ ุบูุท ูุง ุจุทู!");
                }
            } catch (e) {
                console.error("Firebase Error:", e);
                // ูู ุธูุฑ ูู ุงูุฎุทุฃ ุฏู ุชุงููุ ุจุต ุนูู ุงูู Console (F12) ูุชูุงูู ุฑุงุจุท Index ุฏูุณ ุนููู
                alert("ููู ูุดููุฉ ูู ุงูุณูุฑูุฑ.. ุงุฏุฎู ุจุงูููุฒุฑ admin ุญุงููุงู");
            }
        };

        function applyDynamicPermissions(perms) {
            // ุฅุฎูุงุก/ุฅุธูุงุฑ ุงูุนูุงุตุฑ ุจูุงุกู ุนูู ุงูุตูุงุญูุงุช ุงููุฎุฒูุฉ
            if(!perms.orders) document.getElementById('nav-orders').style.display = 'none';
            if(!perms.records) document.getElementById('nav-records').style.display = 'none';
            if(!perms.chat) document.getElementById('nav-chat').style.display = 'none';
            if(!perms.products) document.getElementById('nav-products').style.display = 'none';
            if(!perms.categories) document.getElementById('nav-categories').style.display = 'none';

            // ุฅุฎูุงุก ุฃุฒุฑุงุฑ ุงูุฅุถุงูุฉ ูู ูููุด ุตูุงุญูุฉ ููุชุฌุงุช
            if(!perms.products) {
                document.getElementById('nav-add-product').style.display = 'none';
                document.getElementById('nav-staff').style.display = 'none';
            }
        }

        // ุชุนุฏูู ุฏุงูุฉ ุงูุฎุฑูุฌ (Logout)
        document.querySelector('.logout-btn').onclick = () => {
            location.reload(); // ุฃุณูู ุทุฑููุฉ ูุนูู ุชุณุฌูู ุฎุฑูุฌ ูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
        };
      </script>

      <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, orderBy, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyArc3Y--aq-6e8omAbcpm8fZ5BvNcYMtkw",
            authDomain: "karmasha-bfad3.firebaseapp.com",
            projectId: "karmasha-bfad3",
            storageBucket: "karmasha-bfad3.firebasestorage.app",
            messagingSenderId: "584846393500",
            appId: "1:584846393500:web:5a58f969f3a66126026d59",
            measurementId: "G-G518D7LXSS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;

        // ุฃุถู ูุฐู ุงูุฃุณุทุฑ ูุฑุจุท ุฏูุงู ูุงูุฑุจูุฒ ุจุงููุงูุฐุฉ ุงูุนุงูููุฉ
        window.query = query;
        window.where = where;
        window.collection = collection;
        window.getDocs = getDocs;
        window.orderBy = orderBy;

        // ุชุนุฑูู ุตูุช ุงูุชูุจูู (ุตูุช ุฌุฑุณ ุชูุจูู)
        const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        alertSound.loop = false; // ูู ุนุงูุฒู ููุฑุฑ ุงูุตูุช ุฎููู true
        let isFirstLoad = true; // ูุชุบูุฑ ุนุดุงู ูููุน ุงูุตูุช ูุดุชุบู ููู ุงูุทูุจุงุช ุงููุฏููุฉ ุฃูู ูุง ุชูุชุญ ุงูุตูุญุฉ

        const qOrders = query(collection(db, "orders"), orderBy("createdAt", "desc"));

        onSnapshot(qOrders, (snapshot) => {
            const newO = document.getElementById('new-orders');
            const kitO = document.getElementById('kitchen-orders');
            newO.innerHTML = ''; kitO.innerHTML = '';

            // ูุฑุงูุจุฉ ุงูุชุบููุฑุงุช (ูู ููู ุฃูุฑุฏุฑ ุฌุฏูุฏ ุงูุถุงู)
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added" && !isFirstLoad) {
                    const order = change.doc.data();
                    if (order.status === "ุฌุฏูุฏ") {
                        // ุชุดุบูู ุงูุตูุช
                        alertSound.play().catch(error => {
                            console.log("ุงููุชุตูุญ ููุน ุงูุตูุช.. ูุงุฒู ุชุถุบุท ูู ุฃู ููุงู ูู ุงูุตูุญุฉ ุงูุฃูู ุนุดุงู ูุดุชุบู.");
                        });

                        // ุงุฎุชูุงุฑู: ุฅุดุนุงุฑ ูู ุงููุชุตูุญ
                        if (Notification.permission === "granted") {
                            new Notification("ูุฑูุดุฉ - ุทูุจ ุฌุฏูุฏ!", { body: `ุทูุจ ุฌุฏูุฏ ูู ${order.customerName}` });
                        }
                    }
                }
            });

            snapshot.forEach(d => {
                const o = d.data();
                const html = `
                <div class="order-card">
                    <div class="card-header"><span class="order-id">#${d.id.substring(0,4)}</span></div>
                    <h4>${o.customerName}</h4>
                    <p><i class="fas fa-phone"></i> ${o.customerPhone}</p>
                    <p><i class="fas fa-map-marker-alt"></i> ${o.customerAddress}</p>
                    <div style="font-size:13px; color:#d2000a; margin-top:8px; font-weight:bold; background:#fff1f1; padding:5px; border-radius:5px;">
                        ${o.items.map(i => i.name).join(' + ')}
                    </div>
                    <div class="card-footer">
                        ${o.status == 'ุฌุฏูุฏ' ?
                            `<button class="details-btn" onclick="window.upStat('${d.id}','ูู ุงููุทุจุฎ')">ูุจูู โ</button>` :
                            `<button class="details-btn" style="background:green; color:white;" onclick="window.upStat('${d.id}','ุชู')">ุชู ุงูุชูุตูู ๐ต</button>`
                        }

                        <!-- ุฒุฑุงุฑ ุงูุฅูุบุงุก ุงูุฌุฏูุฏ -->
                        <button class="details-btn" style="background:#f44336; color:white; margin-right:5px;" onclick="window.askCancel('${d.id}')">ุฅูุบุงุก โ</button>

                        <span class="price">${o.totalPrice}ุฌ</span>
                    </div>
                </div>`;

                if(o.status == 'ุฌุฏูุฏ') newO.innerHTML += html;
                else if(o.status == 'ูู ุงููุทุจุฎ') kitO.innerHTML += html;
            });

            isFirstLoad = false; // ุจุนุฏ ุฃูู ุชุญูููุ ุฃู ุฅุถุงูุฉ ุชุงููุฉ ูุชุดุบู ุงูุตูุช
        });
        window.upStat = async (id,s) => await updateDoc(doc(db,"orders",id),{status:s});

        // ุฏุงูุฉ ูุฅูุบุงุก ุงูุทูุจ ูุน ุทูุจ ุงูุณุจุจ
        window.askCancel = async (id) => {
            const reason = prompt("ูุฑุฌู ุฅุฏุฎุงู ุณุจุจ ุฅูุบุงุก ุงูุทูุจ (ูุซูุงู: ุงูุนููู ูุง ูุฑุฏุ ุงูููุชุฌ ุบูุฑ ูุชููุฑ):");

            // ูู ุงูุฅุฏูู ุถุบุท Cancel ุฃู ุณุงุจ ุงูุฎุงูุฉ ูุงุถูุฉ
            if (reason === null) return;
            if (reason.trim() === "") {
                alert("ูุงุฒู ุชูุชุจ ุณุจุจ ุนุดุงู ุชูุบู ุงูุฃูุฑุฏุฑ!");
                return;
            }

            try {
                await updateDoc(doc(db, "orders", id), {
                    status: "ููุบู",
                    cancelReason: reason // ุญูุธ ุงูุณุจุจ ูู ูุงูุฑุจูุฒ
                });
                alert("ุชู ุฅูุบุงุก ุงูุทูุจ ูุชุณุฌูู ุงูุณุจุจ.");
            } catch (e) {
                console.error("ุฎุทุฃ ูู ุงูุฅูุบุงุก: ", e);
            }
        };

        // ุทูุจ ุฅุฐู ุฅุดุนุงุฑุงุช ุงููููุฏูุฒ
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        // 2. ุฅุฏุงุฑุฉ ุงูุฃูุณุงู (Firebase Categories - ุงูุชุนุฏูู ุงูุฌุฏูุฏ)
        // ุฏุงูุฉ ูุนุฑุถ ุงูุฃูุณุงู ูู ุงูุฌุฏูู ููู ูุงุฆูุฉ ุฅุถุงูุฉ ุงูููุชุฌ
        function listenToCategories() {
            const q = query(collection(db, "categories"), orderBy("createdAt", "asc"));
            onSnapshot(q, (snapshot) => {
                const select = document.getElementById('categorySelect');
                const table = document.getElementById('admin-categories-table');
                
                // ุชูุธูู ุงูููุงุฆู
                select.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุณู</option>';
                table.innerHTML = '';

                snapshot.forEach(docSnap => {
                    const cat = docSnap.data();
                    // ุฅุถุงูุฉ ููุฌุฏูู
                    table.innerHTML += `
                        <tr>
                            <td>${cat.name}</td>
                            <td><button onclick="window.deleteCategory('${docSnap.id}')" class="btn-edit" style="background:#c62828;">ุญุฐู</button></td>
                        </tr>`;
                    // ุฅุถุงูุฉ ูููุงุฆูุฉ ุงูููุณุฏูุฉ
                    select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                });
            });
        }

        // ุฏุงูุฉ ุญูุธ ูุณู ุฌุฏูุฏ ูู ูุงูุฑุจูุฒ
        window.saveCategory = async function() {
            const input = document.getElementById('categoryInput');
            const name = input.value.trim();
            if(!name) return alert("ุงูุชุจ ุงุณู ุงููุณู!");
            
            try {
                await addDoc(collection(db, "categories"), {
                    name: name,
                    createdAt: serverTimestamp()
                });
                input.value = ''; // ุชูุฑูุบ ุงูุญูู
                alert("ุชู ุฅุถุงูุฉ ุงููุณู ุจูุฌุงุญ ููุธูุฑ ุงูุขู ูู ูู ุงูุฃุฌูุฒุฉ");
            } catch(e) {
                console.error(e);
                alert("ุญุฏุซ ุฎุทุฃ ูู ุงูุฅุถุงูุฉ");
            }
        }

        // ุฏุงูุฉ ุญุฐู ูุณู
        window.deleteCategory = async function(id) {
            if(confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุณูุ")) {
                await deleteDoc(doc(db, "categories", id));
            }
        }

        // ุชุดุบูู ูุฑุงูุจ ุงูุฃูุณุงู
        listenToCategories();


        // 3. ุงูููุชุฌุงุช (Products)
        window.saveProduct = async function() {
            const name = document.getElementById('food-name').value;
            const desc = document.getElementById('food-desc').value;
            const cat = document.getElementById('categorySelect').value;
            const rows = document.querySelectorAll('.price-row');
            let prices = [];
            
            // ุชุฌููุน ุงูุฃุณุนุงุฑ
            rows.forEach(r => {
                const s = r.querySelector('.size-input').value;
                const p = r.querySelector('.price-input').value;
                if(s && p) prices.push({size: s, price: parseInt(p)});
            });

            if(!cat) return alert("ูุงุฒู ุชุฎุชุงุฑ ุงููุณู!");
            if(prices.length === 0) return alert("ูุงุฒู ุชุถูู ุณุนุฑ ูุงุญุฏ ุนูู ุงูุฃูู");

            await addDoc(collection(db, "products"), { 
                name, description: desc, category: cat, prices, img: window.productImg||'', createdAt: serverTimestamp() 
            });
            alert("ุชู ุญูุธ ุงูููุชุฌ!"); location.reload();
        }

        // ุชุญููู ุงูููุชุฌุงุช
        async function loadProds() {
            const s = await getDocs(collection(db, "products"));
            const t = document.getElementById('products-table-body'); t.innerHTML='';
            s.forEach(d => {
                const p = d.data();
                t.innerHTML+=`<tr><td>${p.name}</td><td>${p.prices && p.prices[0] ? p.prices[0].price : 'ุบูุฑ ูุญุฏุฏ'}</td><td>${p.category}</td><td><button onclick="window.delP('${d.id}')" style="color:red">X</button></td></tr>`;
            });
        }
        window.delP = async(id) => { if(confirm('ุญุฐูุ')) await deleteDoc(doc(db,"products",id)); loadProds(); }
        loadProds();

        // ูุนุงูุฌุฉ ุงูุตูุฑ
        window.productImg = "";
        document.getElementById('food-img-file').addEventListener('change', e=>{
            const r=new FileReader(); r.onload=()=>window.productImg=r.result; r.readAsDataURL(e.target.files[0]);
        });
        
        // ูุณุงุนุฏุฉ ุงููุงุฌูุฉ
        window.addPriceRow = () => document.getElementById('prices-container').innerHTML += `<div class="price-row"><input type="text" class="size-input"><input type="number" class="price-input"><button type="button" onclick="this.parentElement.remove()">x</button></div>`;
        document.getElementById('add-food-form').onsubmit=(e)=>{e.preventDefault();window.saveProduct()};

        // Navigation
        const items = document.querySelectorAll('.side-nav li');
        const secs = document.querySelectorAll('.admin-section');
        items.forEach(item => {
            item.addEventListener('click', function() {
                items.forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                secs.forEach(s => s.classList.remove('active'));

                const t = this.innerText;
                if(t.includes("ุงูุทูุจุงุช")) {
                    document.getElementById('live-orders-section').classList.add('active');
                } else if(t.includes("ุงูุณุฌู")) {
                    document.getElementById('records-section').classList.add('active');
                    loadRecords(); // ุงุณุชุฏุนุงุก ุฏุงูุฉ ุชุญููู ุงูุจูุงูุงุช ููุง ููุชุญ ุงูุณุฌู
                } else if(t.includes("ุงูููุชุฌุงุช")) {
                    document.getElementById('manage-products-section').classList.add('active');
                } else if(t.includes("ุฅุถุงูุฉ")) {
                    document.getElementById('add-product-section').classList.add('active');
                } else if(t.includes("ุงูุฃูุณุงู")) {
                    document.getElementById('manage-categories-section').classList.add('active');
                } else if(t.includes("ุงูููุธููู")) {
                    document.getElementById('manage-staff-section').classList.add('active');
                }
            });
        });

        // ุฏุงูุฉ ุชุญููู ุณุฌู ุงูุทูุจุงุช ุจุงููุงูู
        async function loadRecords() {
            const tableBody = document.getElementById('records-table-body');
            const totalSalesDisplay = document.getElementById('total-sales-amount');

            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ุฌุงุฑู ุชุญููู ุงูุณุฌู...</td></tr>';

            try {
                // ุฌูุจ ูู ุงูุทูุจุงุช ูู ุงูุฃุญุฏุซ ููุฃูุฏู
                const q = query(collection(window.db, "orders"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);

                tableBody.innerHTML = ''; // ุชูุฑูุบ ุงูุฌุฏูู
                let totalSales = 0;

                querySnapshot.forEach((doc) => {
                    const order = doc.data();
                    const date = order.createdAt ? order.createdAt.toDate().toLocaleString('ar-EG') : 'ุบูุฑ ูุณุฌู';

                    // ุญุณุงุจ ุงูุฅุฌูุงูู ุงูููู
                    totalSales += parseFloat(order.totalPrice || 0);

                    // ุชุญููู ูุงุฆูุฉ ุงููุฌุจุงุช ููุต
                    const itemsList = order.items.map(i => i.name).join(' + ');

                    let statusDisplay = order.status;

                    // ูู ุงูุญุงูุฉ ููุบูุ ุถูู ุงูุณุจุจ ุชุญุช ุงููููุฉ
                    if (order.status === "ููุบู") {
                        const reason = order.cancelReason || "ุบูุฑ ูุญุฏุฏ";
                        statusDisplay = `<span style="color:#ffc107;">ููุบู</span><br><small style="color:#ffeb3b; font-size:10px;">ุงูุณุจุจ: ${reason}</small>`;
                    } else {
                        statusDisplay = `<span style="color:white;">${order.status}</span>`;
                    }

                    tableBody.innerHTML += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px;">#${doc.id.substring(0, 5)}</td>
                            <td>${date}</td>
                            <td>${order.customerName} <br> <small>${order.customerPhone}</small></td>
                            <td>${itemsList}</td>
                            <td>${order.totalPrice} ุฌ</td>
                            <td>
                                <div class="status-badge" style="background:${getStatusColor(order.status)}; padding:5px; border-radius:5px; text-align:center;">
                                    ${statusDisplay}
                                </div>
                            </td>
                        </tr>
                    `;
                });

                totalSalesDisplay.innerText = totalSales; // ุชุญุฏูุซ ุฑูู ุฅุฌูุงูู ุงููุจูุนุงุช

            } catch (error) {
                console.error("Error loading records: ", error);
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">ูุดู ุชุญููู ุงูุจูุงูุงุช. ุชุฃูุฏ ูู ุฅุนุฏุงุฏุงุช ุงูู Index ูู Firebase.</td></tr>';
            }
        }

        // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชูููู ุญุงูุฉ ุงูุทูุจ
        function getStatusColor(status) {
            if (status === "ุฌุฏูุฏ") return "#e31e24";
            if (status === "ูู ุงููุทุจุฎ") return "#1976d2";
            if (status === "ุชู") return "#2e7d32";
            if (status === "ููุบู") return "#212121"; // ุฃุณูุฏ/ุฑูุงุฏู ุบุงูู
            return "#757575";
        }

        window.filterRecords = function() {
            let input = document.getElementById("searchOrders").value.toLowerCase();
            let rows = document.querySelectorAll("#records-table-body tr");

            rows.forEach(row => {
                let text = row.innerText.toLowerCase();
                row.style.display = text.includes(input) ? "" : "none";
            });
        }

        // 4. ุฅุฏุงุฑุฉ ุงูููุธููู (Staff)
        // ุฏุงูุฉ ุญูุธ ุงูููุธู ุจูุงูุฑุจูุฒ
        window.saveNewStaff = async function() {
            console.log("ุฌุงุฑู ูุญุงููุฉ ุญูุธ ููุธู..."); // ููุชุฃูุฏ ูู ุงูู Console ุฅู ุงูุฒุฑุงุฑ ุดุบุงู

            const user = document.getElementById('staff-username').value.trim();
            const pass = document.getElementById('staff-password').value.trim();
            const job = document.getElementById('staff-job-title').value.trim();

            // ุฌูุน ุงูุตูุงุญูุงุช
            let permissions = {};
            document.querySelectorAll('.perm-check').forEach(check => {
                permissions[check.value] = check.checked;
            });

            if(!user || !pass) {
                alert("ูุง ุจุทู ูุงุฒู ุชูุชุจ ุงุณู ุงููุณุชุฎุฏู ูุงูุจุงุณูุฑุฏ!");
                return;
            }

            try {
                await addDoc(collection(window.db, "staff"), {
                    username: user,
                    password: pass,
                    jobTitle: job,
                    permissions: permissions,
                    createdAt: serverTimestamp()
                });

                alert("ูุจุฑูู! ุงูููุธู ุงูุถุงู ุจูุฌุงุญ.");

                // ุชูุฑูุบ ุงูุฎุงูุงุช ุจุนุฏ ุงูุญูุธ
                document.getElementById('staff-username').value = "";
                document.getElementById('staff-password').value = "";
                document.getElementById('staff-job-title').value = "";

                // ุฅุนุงุฏุฉ ุชุญููู ุงูุฌุฏูู ููุฑุงู
                loadStaffList();

            } catch(e) {
                console.error("Error saving staff:", e);
                alert("ุญุตูุช ูุดููุฉ ูุฃุญูุง ุจูุญูุธ ุงูุจูุงูุงุช");
            }
        };

        // ุฏุงูุฉ ุชุญููู ูุงุฆูุฉ ุงูููุธููู
        window.loadStaffList = async function() {
            const tbody = document.getElementById('staff-table-body');
            if(!tbody) return;

            tbody.innerHTML = '<tr><td colspan="4">ุฌุงุฑู ุงูุชุญููู...</td></tr>';

            try {
                const snapshot = await getDocs(collection(window.db, "staff"));
                tbody.innerHTML = ''; // ุชูุฑูุบ ุงูุฌุฏูู ุนุดุงู ููููู

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4">ูุง ููุฌุฏ ููุธููู ุญุงููุงู</td></tr>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const s = docSnap.data();
                    // ุชุญููู ุงูุตูุงุญูุงุช ููุต ููููู
                    const permsKeys = {
                        orders: "ุทูุจุงุช",
                        records: "ุณุฌู",
                        chat: "ุดุงุช",
                        products: "ููุชุฌุงุช",
                        categories: "ุฃูุณุงู"
                    };
                    const activePerms = Object.keys(s.permissions)
                                        .filter(k => s.permissions[k])
                                        .map(k => permsKeys[k])
                                        .join(' - ');

                    tbody.innerHTML += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding:10px;"><b>${s.username}</b></td>
                            <td>${s.jobTitle || 'ููุธู'}</td>
                            <td style="font-size:12px; color:#d2000a;">${activePerms}</td>
                            <td>
                                <button onclick="deleteStaff('${docSnap.id}')"
                                        style="background:#ff4d4d; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">
                                    ุญุฐู
                                </button>
                            </td>
                        </tr>`;
                });
            } catch(e) {
                console.error("Error loading staff:", e);
                tbody.innerHTML = '<tr><td colspan="4">ุฎุทุฃ ูู ุชุญููู ุงูููุธููู</td></tr>';
            }
        };

        // ุฏุงูุฉ ุญุฐู ุงูููุธู
        window.deleteStaff = async (id) => {
            if(confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูููุธูุ")) {
                await deleteDoc(doc(window.db, "staff", id));
                loadStaffList(); // ุชุญุฏูุซ ุงูุฌุฏูู
            }
        };

    </script>
</body>
</html>
